<!-- Unified Voice + Text chatbot using Vapi.ai (fixed) -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AI Voice + Text Chat</title>
<script src="https://cdn.vapi.ai/voice.umd.js" defer></script>
<style>
 body{font-family:sans-serif;background:#f7f7f7;margin:0;padding:24px;display:flex;flex-direction:column;align-items:center}
 #chat{border:1px solid #ccc;border-radius:8px;padding:12px;height:340px;overflow-y:auto;background:#fff;width:100%;max-width:520px}
 .bubble{white-space:pre-wrap;overflow-wrap:anywhere;padding:8px 12px;border-radius:12px;margin:6px 0;max-width:85%}
 .user{background:#cce5ff;text-align:right;margin-left:auto}
 .bot {background:#e8e8e8;text-align:left}
 #controls{display:flex;gap:8px;margin-top:12px;max-width:520px;width:100%}
 textarea{flex:1;padding:10px;border:1px solid #ccc;border-radius:6px;resize:vertical}
 button{padding:10px 16px;border:none;border-radius:8px;font-size:1rem;cursor:pointer}
 #sendBtn{background:#007bff;color:#fff}
 #micBtn{background:#28a745;color:#fff}
 #micBtn.listening{background:#e55353}
</style>
</head>
<body>
 <h3>Talk or Type to our AI Assistant</h3>
 <div id="chat"></div>
 <div id="controls">
   <textarea id="txtInput" rows="2" placeholder="Type here or use the mic‚Ä¶"></textarea>
   <button id="sendBtn">Send</button>
   <button id="micBtn">üé§</button>
 </div>

<script>
// ======== CONFIG ========
const API_KEY  = 'pk_live_414f3957-a9b2-4140-9423-4a10cabf4761'; // TODO: replace with your public key
const AGENT_ID = '04679032-2b78-446c-9a95-bfc719ef7a66';
// =========================

const chat   = document.getElementById('chat');
const txt    = document.getElementById('txtInput');
const send   = document.getElementById('sendBtn');
const micBtn = document.getElementById('micBtn');

function add(side, text){
  const div = document.createElement('div');
  div.className = 'bubble ' + (side==='bot'?'bot':'user');
  div.textContent = text;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

// === Text send ===
async function sendText(){
  const msg = txt.value.trim();
  if(!msg) return;
  add('user', msg);
  txt.value = '';
  send.disabled = true;
  try{
    const r = await fetch('https://api.vapi.ai/v1/messages',{
      method:'POST',
      headers:{ 'Content-Type':'application/json', Authorization:'Bearer '+API_KEY },
      body: JSON.stringify({ agent: AGENT_ID, text: msg })
    });
    const j = await r.json();
    console.debug('Vapi /messages response', j);
    const answer = j.reply || j.response || j.text || (j.data && (j.data.reply||j.data.response)) || '[no reply]';
    add('bot', answer);
  }catch(e){ add('bot','‚ö†Ô∏è '+e.message); }
  finally{ send.disabled = false; }
}

send.onclick = sendText;
txt.addEventListener('keydown', e=>{ if(e.key==='Enter'&&!e.shiftKey){ e.preventDefault(); sendText(); } });

// === Voice init after SDK loads ===
function initVoice(){
  if(!window.Vapi){ return setTimeout(initVoice,100); }
  const v = new Vapi({ apiKey: API_KEY, agent: AGENT_ID, micButton: '#micBtn', partials: true });
  v.on('speech.start', ()=> micBtn.classList.add('listening'));
  v.on('speech.stop',  ()=> micBtn.classList.remove('listening'));
  v.on('transcript',   t => { if(!t.isPartial) add('user', t.text); });
  v.on('response',     r => add('bot', r.text));
  v.on('error',        e => add('bot', '‚ö†Ô∏è '+e.message));
}
initVoice();
</script>
</body>
</html>
